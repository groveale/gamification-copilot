# Copilot Gamification API wiki

## Core Features

* Record M365 Copilot Usage
* Record Agent Usage
* Activity API subscription
* Encryption

### üîê Encryption

A core requirement of this system is to **protect user privacy** and ensure that no **Personally Identifiable Information (PII)** is exposed through gamification data.

#### üì¶ Where Data Lives

We store individual usage data in **Azure Table Storage**. Access to this data is relatively easy for users who have permissions to the Azure subscription. Therefore, **encryption at rest** is critical.

To mitigate exposure risks, the function **encrypts all PII** before storage. For instance, **User Principal Names (UPNs)** are stored in an encrypted form. This ensures that even if someone gains access to the storage account, they cannot correlate usage data with a specific user **without access to the encryption key**.

#### üîç How It Works

When a user's Copilot interaction is received, the UPN is encrypted using **deterministic encryption**. This approach is necessary because we use the **encrypted UPN as a searchable index** in Table Storage‚Äîproviding fast and efficient lookups.

> **Deterministic encryption** means the same input (UPN), using the same key and initialization vector (IV), always results in the same output (ciphertext).

##### üí° Formula:

```
UPN + same key + fixed IV = same ciphertext every time
```

This is **less secure than standard encryption** (which typically uses a random IV), but it's a necessary trade-off to meet our requirements for **indexing and fast retrieval**.

Here‚Äôs the relevant code snippet showing the fixed 16-byte IV:

```csharp
private readonly byte[] _iv = Encoding.UTF8.GetBytes("16bytes-fixed-iv"); // 16 bytes (DON'T CHANGE IF DETERMINISTIC)
```

##### üîë The Key

The encryption key is **generated by the administrator** who deploys the API (Azure Function).

- The key is automatically added as a **secret in the provisioned Azure Key Vault**.
- Only the Azure Function has permission to access this key.
- The secret name is specified in app settings:

```ini
KeyVault:EncryptionKeySecretName
```

#### üîÑ Key Rotation

We provide a built-in mechanism for **key rotation**, which ensures continued security and compliance. The process involves **two API calls**. These can be found in the `KeyRotation` http trigger

##### ‚úÖ Step 1: Prepare for Rotation

- Puts the function into a **paused state** (e.g., stops accepting webhook events).
- Decrypts all UPNs using the **current key**.
- Re-encrypts them using the **new key**.

At this point, all recent data is now encrypted with the new key.

This step is executed by hitting the endpoint `.../api/KeyRotation` with two query params

* `mode` = `prepare`
* `newKeyVaultEncryptionKeySecretName` = `<secretnameinkeyvalut>`

The prereq for this call is having the new key added as a secret in the keyvault

##### üöÄ Step 2: Activate New Key

- Update the app setting `KeyVault:EncryptionKeySecretName` to point to the **new secret name**.
- Make a **final API call** to validate the rotation and **reactivate the webhook listener**.
- All **future data** will now be encrypted using the **new key**.

This step is executed by hitting the same endpoint `.../api/KeyRotation` with one query param

* `mode` = `confirm`


> ‚ö†Ô∏è **Note:** Only the last **7 days of data** are rotated. Aggregated data (weekly, monthly, and all-time) will also undergo re-encryption during this process.


## Additional Features

* Skip excluded users
* Skip offline users
* Test data


### üö´ Skip Excluded Users

To ensure compliance with data privacy regulations, the system includes functionality to **exclude specific users** from having their data recorded or processed.

This exclusion mechanism applies in two key scenarios:
- **Real-time data ingestion:** Each time the API receives new data.
- **Daily aggregation:** During scheduled data processing using Copilot Admin Reports.

If a user's **User Principal Name (UPN)** appears on the exclusion list, then:
- Their activity **will not be recorded**.
- They will be **excluded from all gamification features**.

#### üìã Where the Exclusion List Resides

The list of excluded users is maintained in a **SharePoint List**. The specific **site** and **list ID** are configured through the **function app‚Äôs environment variables**.

#### ‚öôÔ∏è How It Works

- On **startup**, the function reads the SharePoint list and **builds a cache** of excluded UPNs.
- During normal operation, the API will refer to this **cache** for user exclusion checks.
- If the cache has **expired** (i.e. gone ‚Äúcold‚Äù), the function will **refresh the list from SharePoint** and rebuild the cache.

By default, the **cache expires every 30 minutes**, but this is configurable.

#### üß† Cache Configuration

The cache logic is implemented in the `ExclusionEmailService.cs` file.

To change the default cache expiry time, locate the following line (line 27 by default):

```csharp
private static readonly TimeSpan DefaultCacheExpiry = TimeSpan.FromMinutes(30);
```

### üì¥ Skip Offline Users

To ensure fairness in streak tracking and inactivity scoring, the system implements logic to **skip users who are offline**.

#### Activity Detection

The system uses the **Microsoft 365 activity report** to determine whether a user was active on the day Copilot data is processed. This is done via the API:

`GET https://graph.microsoft.com/beta/reports/getOffice365ActiveUserDetail(date=2025-06-27)`

The `date` parameter corresponds to the **report refresh date** returned by the Copilot activity API.

#### ‚úÖ Online Criteria

A user is considered **online** if they show activity in any of the following services on the report date:

- Microsoft Teams
- Outlook
- OneDrive
- SharePoint

If no activity is detected, the user is **excluded** from gamification data for that day. This ensures they do not lose streaks or accrue inactivity unfairly.

#### üîÑ Fallback Handling

The Copilot API may be ahead of the usage API. If the API returns no data for a given day, a fallback is triggered using:

`GET https://graph.microsoft.com/beta/reports/getOffice365ActiveUserDetail(period='D7')`


This allows retrieval of Copilot license information. If it's still not possible to determine whether a user is offline or inactive, the user is treated as **inactive** and will **lose streaks**.

#### üß† Implementation

This logic is implemented in the `GraphService.cs` file, specifically in the methods:

```csharp
GetM365CopilotUsersAsync()
GetM365CopilotUserFallBackAsync()
```


### Test data

to allow testing